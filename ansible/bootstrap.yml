- hosts: '{{ hosts }}'
  remote_user: '{{ user }}'
  vars_files:
  - roles/dlock-common/vars/main.yml
  become: True
  tasks:
  - name: Packages
    apt:
      name: "{{ item }}"
      install_recommends: no
    with_items:
      - git
      - etckeeper
  - name: superuser nopasswd sudo
    copy:
      content: |
        %sudo ALL=(ALL) NOPASSWD: ALL
      dest: /etc/sudoers.d/020_sudo-group-nopasswd 
  - name: superuser accounts
    user:
      name: "{{ item.username }}"
      state: "{{ item.state }}"
      groups: sudo,systemd-journal
      append: yes
    with_items:
      - "{{ superusers }}"
  - name: superuser authorized_keys
    authorized_key:
      user: "{{ item.username }}"
      state: "{{ item.state }}"
      key: "{{ item.authorized_keys }}"
    with_items:
      - "{{ superusers }}"
  - name: Remove default pi user/pass
    user:
      name: pi
      state: absent
      remove: yes
      force: yes # in case some process still uses the user
