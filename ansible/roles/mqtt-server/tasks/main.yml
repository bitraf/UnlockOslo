- name: Mosquitto
  tags: mosquitto
  become: yes
  block:
  - name: Install Mosquitto
    apt:
      name:
        - mosquitto
        - mosquitto-clients
        - python-passlib
      install_recommends: no

  - name: Mosquitto configuration
    copy:
      src: etc/mosquitto/conf.d/dlock.conf
      dest: /etc/mosquitto/conf.d/dlock.conf

  - name: Mosquitto Access Control List
    copy:
      src: etc/mosquitto/conf.d/dlock.acl
      dest: /etc/mosquitto/conf.d/dlock.acl

  - name: Mosquitto config permissions
    file:
      path: /etc/mosquitto/conf.d
      mode: 0750
      owner: mosquitto
      group: root
      recurse: yes

  - name: Password file
    tags: passwd
    copy:
      content: "{{ vault_mqtt_passwd }}"
      dest: "/etc/mosquitto/conf.d/dlock.passwords"
    notify: reload mosquitto

# The format generated by this file is slightly wrong
#  - name: Password file
#    tags: passwd
#    with_dict: "{{ vault_mqtt_credentials }}"
#    no_log: yes
#    htpasswd:
#      path: /etc/mosquitto/conf.d/dlock.passwords2
#      name: "{{ item.key }}"
#      password: "{{ item.value }}-"
#      crypt_scheme: sha512_crypt
#      state: "{{ 'absent' if not item.value or item.value.strip() == '' else 'present' }}"
#    notify: reload mosquitto

  - name: Copy Mosquitto service file
    copy:
      src: etc/systemd/system/mosquitto.service
      dest: /etc/systemd/system/mosquitto.service
    notify: restart mosquitto

  - file:
      path: /etc/letsencrypt/renewal-hooks/deploy
      state: directory
    tags: x

  - template:
      src: etc/letsencrypt/renewal-hooks/deploy/99-mosquitto
      dest: /etc/letsencrypt/renewal-hooks/deploy/99-mosquitto
      mode: u=rx
    tags: x
